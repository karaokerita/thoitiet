<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Th·ªùi ti·∫øt Vi·ªát Nam</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<style>
  :root{
    --card-bg: rgba(255,255,255,0.85);
    --text-dark: #111;
    --muted: #666;
  }
  html, body { height: 100%; }
  body {
    margin: 0;
    font-family: system-ui, -apple-system, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
    background: url('background.jpg') no-repeat center center fixed;
    background-size: cover;
    color: var(--text-dark);
  }
  /* Header sticky nh∆∞ iOS */
  header {
    position: sticky; top: 0; z-index: 1000;
    backdrop-filter: blur(10px);
    background: rgba(255,255,255,0.8);
    box-shadow: 0 2px 12px rgba(0,0,0,0.08);
    padding: 10px 12px;
    text-align: center;
  }
  header h1 { margin: 4px 0 2px; font-size: 20px; font-weight: 700; }
  .clock { font-size: 13px; color: var(--muted); }

  /* L∆∞·ªõi 3 v·ªã tr√≠ c·ªë ƒë·ªãnh */
  .fixed-locations {
    display: grid;
    grid-template-columns: repeat(3, minmax(260px, 1fr));
    gap: 12px;
    padding: 12px;
  }
  @media (max-width: 1024px){
    .fixed-locations { grid-template-columns: repeat(2, minmax(260px, 1fr)); }
  }
  @media (max-width: 700px){
    .fixed-locations { grid-template-columns: 1fr; }
  }

  .loc-card {
    background: var(--card-bg);
    border-radius: 16px;
    overflow: hidden;
    box-shadow: 0 6px 16px rgba(0,0,0,0.12);
  }
  .loc-header {
    display:flex; align-items:center; justify-content:center; gap:8px;
    padding: 10px 12px;
    background: rgba(245,245,245,0.9);
    border-bottom: 1px solid rgba(0,0,0,0.06);
    font-weight: 700;
  }
  .days-vertical { /* danh s√°ch ng√†y d·ªçc ki·ªÉu iOS */
    display: flex; flex-direction: column; gap: 8px;
    padding: 10px;
  }
  .day-row {
    display:flex; align-items:center; justify-content: space-between; gap:8px;
    padding: 8px 10px; border-radius: 12px;
    backdrop-filter: blur(4px);
    /* n·ªÅn x√°m nh·∫π, s·∫Ω tƒÉng ƒë·∫≠m d·∫ßn b·∫±ng inline style */
    background: rgba(242,242,242,0.9);
  }
  .day-left { display:flex; align-items:center; gap:10px; min-width: 140px; }
  .day-left .icon { width: 28px; height: 28px; display:inline-flex; align-items:center; justify-content:center; }
  .day-left .date { font-weight: 600; }
  .day-right { display:flex; align-items:center; gap:12px; }
  .temp-low { color:#1d4ed8; font-weight:600; }
  .temp-high { color:#ef4444; font-weight:700; }
  .rain { color:#0ea5e9; font-weight:600; }

  /* B·∫£n ƒë·ªì d∆∞·ªõi c√πng */
  #map { width: 100%; height: 52vh; margin: 8px 0 16px; }
  .leaflet-popup-content { margin: 8px 8px 6px; }
  .popup-title { font-weight: 800; margin-bottom: 6px; }
  .popup-days { display:flex; flex-direction: column; gap:6px; max-height: 48vh; overflow-y:auto; -webkit-overflow-scrolling: touch; }
  .popup-day { display:flex; align-items:center; justify-content: space-between; gap:8px; padding:6px 8px; border-radius:10px; background: rgba(242,242,242,0.9); }
  .popup-left { display:flex; align-items:center; gap:8px; min-width:135px; }
  .popup-icon { width:22px; height:22px; display:inline-flex; align-items:center; justify-content:center; }
  .muted { color: var(--muted); }

  /* C·∫£i thi·ªán c·∫£m ·ª©ng iOS cho map */
  #map { touch-action: pan-x pan-y; }
</style>
</head>
<body>
  <header>
    <h1>Th·ªùi ti·∫øt Vi·ªát Nam</h1>
    <div class="clock" id="clock"></div>
  </header>

  <!-- 3 v·ªã tr√≠ c·ªë ƒë·ªãnh -->
  <section class="fixed-locations" id="fixedLocations"></section>

  <!-- B·∫£n ƒë·ªì -->
  <div id="map"></div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script>
  // ====== C·∫•u h√¨nh v·ªã tr√≠ c·ªë ƒë·ªãnh ======
  const FIXED = [
    { name: 'ƒê·ª©c Tr·ªçng ‚Äì L√¢m ƒê·ªìng', lat: 11.7417, lon: 108.3733 },
    { name: 'T√¢n An ‚Äì Long An',      lat: 10.5359, lon: 106.4133 },
    { name: 'TP. H·ªì Ch√≠ Minh',       lat: 10.7769, lon: 106.7009 }
  ];

  // ====== ƒê·ªìng h·ªì th·ªùi gian th·ª±c ======
  function tickClock(){
    const now = new Date();
    document.getElementById('clock').textContent = now.toLocaleString('vi-VN', { dateStyle: 'full', timeStyle: 'medium' });
  }
  setInterval(tickClock, 1000); tickClock();

  // ====== API Open-Meteo ======
  async function fetchWeather(lat, lon, startDate = null, endDate = null){
    // N·∫øu kh√¥ng truy·ªÅn ng√†y, Open-Meteo tr·∫£ v·ªÅ 7 ng√†y m·∫∑c ƒë·ªãnh theo timezone auto
    let url = `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}`+
              `&daily=temperature_2m_max,temperature_2m_min,precipitation_probability_mean,weathercode`+
              `&timezone=auto`;
    if (startDate && endDate){
      url += `&start_date=${startDate}&end_date=${endDate}`;
    }
    const res = await fetch(url);
    return res.json();
  }

  // ====== Map Open-Meteo weathercode -> t√™n icon Meteocons (animated) ======
  // CDN: https://unpkg.com/@basmilius/meteocons/animated/<name>.svg
  function codeToMeteocon(code){
    // Nh√≥m t·ªëi gi·∫£n, ƒë·ªß ƒë·∫πp ki·ªÉu iOS
    if (code === 0) return 'clear-day';
    if ([1,2].includes(code)) return 'partly-cloudy-day';
    if (code === 3) return 'cloudy';
    if ([45,48].includes(code)) return 'fog';
    if ([51,53,55,56,57].includes(code)) return 'drizzle';
    if ([61,63,65,66,67,80,81,82].includes(code)) return 'rain';
    if ([71,73,75,77,85,86].includes(code)) return 'snow';
    if ([95,96,99].includes(code)) return 'thunderstorms';
    return 'partly-cloudy-day';
  }
  function iconImg(code, size=32){
    const name = codeToMeteocon(code);
    return `<img class="icon-img" src="https://unpkg.com/@basmilius/meteocons/animated/${name}.svg" width="${size}" height="${size}" alt="${name}">`;
  }

  // ====== M√†u x√°m ƒë·∫≠m d·∫ßn cho 7 ng√†y ======
  function grayStep(i){
    // i: 0..6 -> t·ª´ #f2f2f2 ƒë·∫øn #cfcfcf
    const base = 242; // f2
    const step = 18;  // l√†m ƒë·∫≠m d·∫ßn
    const v = Math.max(207, base - i*step); // t·ªëi ƒëa t·ªõi #cfcfcf
    return `rgba(${v},${v},${v},0.9)`;
  }

  // ====== Render th·∫ª v·ªã tr√≠ c·ªë ƒë·ªãnh (d·ªçc) ======
  function renderFixedCard(container, name, daily){
    const card = document.createElement('div');
    card.className = 'loc-card';
    card.innerHTML = `<div class="loc-header">${name}</div>`;

    const list = document.createElement('div');
    list.className = 'days-vertical';

    daily.time.forEach((t, i)=>{
      const d = new Date(t);
      const row = document.createElement('div');
      row.className = 'day-row';
      row.style.background = grayStep(i);
      row.innerHTML = `
        <div class="day-left">
          <span class="icon">${iconImg(daily.weathercode[i], 28)}</span>
          <div class="date">${d.toLocaleDateString('vi-VN',{ weekday:'short', day:'2-digit', month:'2-digit'})}</div>
        </div>
        <div class="day-right">
          <div class="rain">üíß${(daily.precipitation_probability_mean[i] ?? 0)}%</div>
          <div class="temp-low">${Math.round(daily.temperature_2m_min[i])}¬∞C</div>
          <div class="temp-high">${Math.round(daily.temperature_2m_max[i])}¬∞C</div>
        </div>`;
      list.appendChild(row);
    });

    card.appendChild(list);
    container.appendChild(card);
  }

  async function loadFixedLocations(){
    const wrap = document.getElementById('fixedLocations');
    wrap.innerHTML = '';
    for (const loc of FIXED){
      const data = await fetchWeather(loc.lat, loc.lon);
      renderFixedCard(wrap, loc.name, data.daily);
    }
  }

  // ====== Reverse geocoding (x√£/ph∆∞·ªùng ‚Äì t·ªânh/th√†nh) ======
  async function reverseName(lat, lon){
    const url = `https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}&accept-language=vi`;
    const res = await fetch(url);
    const j = await res.json();
    const a = j.address || {};
    const ward = a.village || a.town || a.suburb || a.city_district || a.hamlet || a.neighbourhood || a.quarter || a.city || '';
    const province = a.state || a.province || a.county || a.region || a.city || '';
    const name = `${ward ? ward : 'Khu v·ª±c'} ‚Äì ${province || 'Vi·ªát Nam'}`;
    return name;
  }

  // ====== Kh·ªüi t·∫°o map v√† popup d·ªçc 7 ng√†y ======
  function initMap(){
    const map = L.map('map', { zoomControl: true }).setView([15.9, 105.8], 5);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19, attribution: '&copy; OpenStreetMap' }).addTo(map);

    // Th√™m marker 3 v·ªã tr√≠ c·ªë ƒë·ªãnh
    FIXED.forEach(f => {
      L.marker([f.lat, f.lon]).addTo(map).bindPopup(`<b>${f.name}</b>`);
    });

    map.on('click', async (e)=>{
      const { lat, lng } = e.latlng;
      const [name, data] = await Promise.all([
        reverseName(lat, lng),
        fetchWeather(lat, lng)
      ]);

      // T·∫°o n·ªôi dung popup d·ªçc 7 ng√†y
      const d = data.daily;
      let html = `<div class="popup-title">${name}</div>`;
      html += `<div class="popup-days">`;
      d.time.forEach((t, i)=>{
        const day = new Date(t).toLocaleDateString('vi-VN', { weekday:'short', day:'2-digit', month:'2-digit' });
        html += `
          <div class="popup-day" style="background:${grayStep(i)}">
            <div class="popup-left">
              <span class="popup-icon">${iconImg(d.weathercode[i], 22)}</span>
              <div>
                <div><strong>${day}</strong></div>
                <div class="muted">üíß${(d.precipitation_probability_mean[i] ?? 0)}%</div>
              </div>
            </div>
            <div>
              <span class="temp-low">${Math.round(d.temperature_2m_min[i])}¬∞C</span>
              &nbsp;/&nbsp;
              <span class="temp-high">${Math.round(d.temperature_2m_max[i])}¬∞C</span>
            </div>
          </div>`;
      });
      html += `</div>`;

      L.popup({ maxWidth: 420, autoPanPaddingTopLeft: [10,10] })
        .setLatLng(e.latlng)
        .setContent(html)
        .openOn(map); // t·ª± ƒë·ªông ƒë√≥ng popup c≈©
    });

    // B·∫Øt touchend ƒë·ªÉ iPhone 15 ch·∫°m ch√≠nh x√°c
    map.on('touchend', (e)=>{
      if (e.latlng) map.fire('click', e); // chuy·ªÉn sang click handler
    });
  }

  // ====== Kh·ªüi ch·∫°y ======
  loadFixedLocations();
  initMap();
  </script>
</body>
</html>
