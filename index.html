<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Thời tiết Việt Nam</title>
<style>
  body { font-family: Arial, sans-serif; background: #eef2f3; margin: 0; padding: 0; }
  header { background: #4a90e2; color: white; padding: 10px; text-align: center; }
  .container { display: flex; }
  #map { height: 500px; width: 50%; }
  .locations { flex: 1; display: flex; flex-wrap: wrap; justify-content: center; padding: 10px; overflow-y: auto; }
  .card { background: white; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.2); margin: 10px; padding: 10px; width: 320px; animation: fadeIn 0.5s ease-in-out; }
  h2 { margin: 0 0 5px 0; }
  .datetime { font-size: 0.9em; color: #555; margin-bottom: 10px; }
  table { width: 100%; border-collapse: collapse; }
  th, td { padding: 5px; text-align: center; }
  @keyframes fadeIn { from {opacity: 0;} to {opacity: 1;} }
</style>
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
</head>
<body>
<header>
  <h1>Thời tiết 3 địa điểm</h1>
  <label>Hiển thị dự báo: 
    <select id="daysSelect">
      <option value="7">7 ngày</option>
      <option value="14">14 ngày</option>
    </select>
  </label>
</header>
<div class="container">
  <div id="map"></div>
  <div class="locations" id="locations"></div>
</div>
<script>
const fixedLocations = [
  {name: 'Đức Trọng – Lâm Đồng', lat: 11.7417, lon: 108.3733},
  {name: 'Tân An – Long An', lat: 10.5359, lon: 106.4133},
  {name: 'TP. Hồ Chí Minh', lat: 10.7769, lon: 106.7009}
];

async function fetchWeather(lat, lon, days) {
  const url = `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&daily=temperature_2m_max,temperature_2m_min,precipitation_sum,precipitation_probability_max&timezone=auto&forecast_days=${days}`;
  const res = await fetch(url);
  return res.json();
}

function renderWeather(location, data) {
  const card = document.createElement('div');
  card.className = 'card';
  const now = new Date();
  const datetimeStr = now.toLocaleString('vi-VN', { dateStyle: 'full', timeStyle: 'short' });
  let html = `<h2>${location.name}</h2><div class="datetime">${datetimeStr}</div>`;
  html += `<table><tr><th>Ngày</th><th>Cao</th><th>Thấp</th><th>Mưa (mm)</th><th>Khả năng mưa (%)</th></tr>`;
  data.daily.time.forEach((date, i) => {
    html += `<tr><td>${date}</td><td>${data.daily.temperature_2m_max[i]}°C</td><td>${data.daily.temperature_2m_min[i]}°C</td><td>${data.daily.precipitation_sum[i]}</td><td>${data.daily.precipitation_probability_max[i] ?? '-'}%</td></tr>`;
  });
  html += `</table>`;
  card.innerHTML = html;
  document.getElementById('locations').appendChild(card);
}

async function loadWeatherForLocation(loc) {
  const days = document.getElementById('daysSelect').value;
  const data = await fetchWeather(loc.lat, loc.lon, days);
  document.getElementById('locations').innerHTML = '';
  renderWeather(loc, data);
}

async function loadAll() {
  document.getElementById('locations').innerHTML = '';
  const days = document.getElementById('daysSelect').value;
  for (const loc of fixedLocations) {
    const data = await fetchWeather(loc.lat, loc.lon, days);
    renderWeather(loc, data);
  }
}

function initMap() {
  const map = L.map('map').setView([11.7417, 108.3733], 6);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '&copy; OpenStreetMap contributors'
  }).addTo(map);

  fixedLocations.forEach(loc => {
    const marker = L.marker([loc.lat, loc.lon]).addTo(map);
    marker.bindPopup(`<b>${loc.name}</b>`);
    marker.on('click', () => loadWeatherForLocation(loc));
  });
}

document.getElementById('daysSelect').addEventListener('change', loadAll);
window.onload = () => {
  initMap();
  loadAll();
};
</script>
</body>
</html>
