<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Dự báo thời tiết</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
<style>
    body {
        margin: 0;
        font-family: Arial, sans-serif;
        background: url('background.jpg') no-repeat center center fixed;
        background-size: cover;
        color: #333;
    }
    h1 {
        text-align: center;
        margin-top: 10px;
        color: #fff;
        text-shadow: 1px 1px 2px #000;
    }
    .controls {
        text-align: center;
        margin: 10px;
        background: rgba(255,255,255,0.8);
        padding: 10px;
        border-radius: 10px;
        display: inline-block;
    }
    .locations {
        display: flex;
        flex-wrap: wrap;
        justify-content: center;
        gap: 20px;
        margin: 20px;
    }
    .location-card {
        flex: 1 1 300px;
        border-radius: 10px;
        padding: 10px;
        background: rgba(255,255,255,0.9);
        box-shadow: 0 2px 6px rgba(0,0,0,0.3);
    }
    .location-card:nth-child(1) { background-color: rgba(173, 216, 230, 0.9); }
    .location-card:nth-child(2) { background-color: rgba(255, 228, 181, 0.9); }
    .location-card:nth-child(3) { background-color: rgba(144, 238, 144, 0.9); }
    .forecast {
        display: flex;
        flex-wrap: wrap;
        gap: 5px;
    }
    .day {
        flex: 1 1 calc(14.28% - 5px);
        min-width: 100px;
        background: #fff;
        border-radius: 6px;
        text-align: center;
        padding: 5px;
        box-shadow: 0 1px 3px rgba(0,0,0,0.2);
    }
    .temp-high { color: red; font-weight: bold; }
    .temp-low { color: blue; }
    #map {
        height: 400px;
        margin-top: 20px;
    }
    .map-popup {
        font-size: 14px;
    }
</style>
</head>
<body>
<h1>Dự báo thời tiết</h1>

<div class="controls">
    <label>Chọn số ngày:
        <select id="dayCount">
            <option value="7">7 ngày</option>
            <option value="14">14 ngày</option>
        </select>
    </label>
    &nbsp;&nbsp;
    <label>Chọn ngày:
        <input type="date" id="customDate">
    </label>
    &nbsp;&nbsp;
    <label>Tìm địa điểm:
        <input type="text" id="searchBox" placeholder="Nhập tên địa điểm...">
        <button id="searchBtn">Tìm</button>
    </label>
</div>

<div class="locations" id="fixedLocations">
    <!-- 3 khu vực cố định -->
</div>

<div id="map"></div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script>
const fixedPlaces = [
    {name: "Đức Trọng - Lâm Đồng", lat: 11.741, lon: 108.355},
    {name: "Tân An - Long An", lat: 10.535, lon: 106.413},
    {name: "TP. Hồ Chí Minh", lat: 10.776, lon: 106.700}
];

const dayCountSelect = document.getElementById('dayCount');
const customDateInput = document.getElementById('customDate');
const fixedContainer = document.getElementById('fixedLocations');

async function getWeather(lat, lon, days) {
    const url = `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&daily=temperature_2m_max,temperature_2m_min,precipitation_probability_max&timezone=auto&forecast_days=${days}`;
    const res = await fetch(url);
    return res.json();
}

function createForecastHTML(data, locationName) {
    const dateList = data.daily.time;
    const maxTemps = data.daily.temperature_2m_max;
    const minTemps = data.daily.temperature_2m_min;
    const rainProb = data.daily.precipitation_probability_max;

    let html = `<div class="location-card"><h2>${locationName}</h2><div class="forecast">`;
    dateList.forEach((date, i) => {
        const dayName = new Date(date).toLocaleDateString('vi-VN', { weekday: 'short' });
        html += `
            <div class="day">
                <div><strong>${dayName}</strong></div>
                <div>${date}</div>
                <div class="temp-high">${maxTemps[i]}°C</div>
                <div class="temp-low">${minTemps[i]}°C</div>
                <div>Xác suất mưa: ${rainProb[i]}%</div>
            </div>
        `;
    });
    html += `</div></div>`;
    return html;
}

async function loadFixedLocations() {
    fixedContainer.innerHTML = '';
    const days = parseInt(dayCountSelect.value);
    let baseDate = customDateInput.value ? new Date(customDateInput.value) : null;

    for (let place of fixedPlaces) {
        let data = await getWeather(place.lat, place.lon, 14); // lấy đủ 14 ngày
        if (baseDate) {
            // lọc 3 ngày trước + 4 ngày sau
            const start = new Date(baseDate);
            start.setDate(start.getDate() - 3);
            const end = new Date(baseDate);
            end.setDate(end.getDate() + 4);

            let idxs = data.daily.time.map((d,i) => {
                let cur = new Date(d);
                return (cur >= start && cur <= end) ? i : null;
            }).filter(i => i !== null);

            data.daily.time = idxs.map(i => data.daily.time[i]);
            data.daily.temperature_2m_max = idxs.map(i => data.daily.temperature_2m_max[i]);
            data.daily.temperature_2m_min = idxs.map(i => data.daily.temperature_2m_min[i]);
            data.daily.precipitation_probability_max = idxs.map(i => data.daily.precipitation_probability_max[i]);
        } else {
            // lấy số ngày theo chọn
            for (let key in data.daily) {
                data.daily[key] = data.daily[key].slice(0, days);
            }
        }
        fixedContainer.innerHTML += createForecastHTML(data, place.name);
    }
}

// Khởi tạo map
const map = L.map('map').setView([14.0583, 108.2772], 5);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '&copy; OpenStreetMap'
}).addTo(map);

// Thêm marker cho 3 vị trí cố định
fixedPlaces.forEach(p => {
    L.marker([p.lat, p.lon]).addTo(map).bindPopup(`<b>${p.name}</b>`);
});

// Click bản đồ
map.on('click', async function(e) {
    const lat = e.latlng.lat;
    const lon = e.latlng.lng;
    let data = await getWeather(lat, lon, 7);
    let popupHTML = `<div class="map-popup"><b>Dự báo tại (${lat.toFixed(2)}, ${lon.toFixed(2)})</b><br>`;
    data.daily.time.forEach((date, i) => {
        const dayName = new Date(date).toLocaleDateString('vi-VN', { weekday: 'short' });
        popupHTML += `${dayName} ${date}: <span style="color:red">${data.daily.temperature_2m_max[i]}°C</span> / <span style="color:blue">${data.daily.temperature_2m_min[i]}°C</span> - Mưa: ${data.daily.precipitation_probability_max[i]}%<br>`;
    });
    popupHTML += `</div>`;
    L.popup().setLatLng(e.latlng).setContent(popupHTML).openOn(map);
});

// Tìm kiếm
document.getElementById('searchBtn').addEventListener('click', async () => {
    const q = document.getElementById('searchBox').value;
    if (!q) return;
    const geoRes = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(q)}`);
    const geoData = await geoRes.json();
    if (geoData.length > 0) {
        const { lat, lon, display_name } = geoData[0];
        map.setView([lat, lon], 10);
        L.marker([lat, lon]).addTo(map).bindPopup(display_name).openPopup();
    } else {
        alert('Không tìm thấy địa điểm');
    }
});

dayCountSelect.addEventListener('change', loadFixedLocations);
customDateInput.addEventListener('change', loadFixedLocations);

loadFixedLocations();
</script>
</body>
</html>
