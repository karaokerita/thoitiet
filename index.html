<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Thời tiết Việt Nam</title>

<!-- Leaflet CSS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
<!-- Weather Icons (iOS style) -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/weather-icons/2.0.10/css/weather-icons.min.css">
<!-- Font -->
<link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">

<style>
  body {
    margin: 0;
    font-family: 'Roboto', sans-serif;
    background: url('background.jpg') no-repeat center center fixed;
    background-size: cover;
    color: #333;
  }
  header {
    position: sticky;
    top: 0;
    background: rgba(255,255,255,0.9);
    padding: 10px;
    text-align: center;
    font-weight: bold;
    font-size: 20px;
    z-index: 1000;
  }
  .current-time {
    font-size: 14px;
    margin-top: 4px;
    color: #555;
  }
  .weather-container {
    display: flex;
    flex-wrap: wrap;
    justify-content: center;
    gap: 10px;
    padding: 10px;
  }
  .location-block {
    flex: 1 1 300px;
    background: rgba(255,255,255,0.85);
    border-radius: 10px;
    padding: 10px;
  }
  .location-title {
    font-size: 16px;
    font-weight: bold;
    margin-bottom: 5px;
    text-align: center;
  }
  .forecast-grid {
    display: flex;
    overflow-x: auto;
    gap: 5px;
  }
  .day-card {
    flex: 0 0 auto;
    min-width: 80px;
    border-radius: 8px;
    padding: 5px;
    text-align: center;
    color: #fff;
  }
  .day-name {
    font-weight: bold;
  }
  .temp-high {
    color: red;
  }
  .temp-low {
    color: blue;
  }
  #map {
    width: 100%;
    height: 400px;
    margin-top: 10px;
  }
  .leaflet-popup-content {
    font-size: 14px;
  }
</style>
</head>
<body>

<header>
  Thời tiết Việt Nam
  <div class="current-time" id="currentTime"></div>
</header>

<div class="weather-container" id="fixedLocations"></div>

<div id="map"></div>

<!-- Leaflet JS -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
const fixedLocations = [
  { name: "Đức Trọng - Lâm Đồng", lat: 11.7416, lon: 108.3733 },
  { name: "Tân An - Long An", lat: 10.5353, lon: 106.4137 },
  { name: "TP. Hồ Chí Minh", lat: 10.7769, lon: 106.7009 }
];

const dayColors = [
  "#777", "#666", "#555", "#444", "#333", "#222", "#111"
];

function updateTime() {
  const now = new Date();
  document.getElementById("currentTime").textContent = now.toLocaleString("vi-VN");
}
setInterval(updateTime, 1000);
updateTime();

async function getWeather(lat, lon) {
  const url = `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&daily=temperature_2m_max,temperature_2m_min,precipitation_probability_mean,weathercode&timezone=auto`;
  const res = await fetch(url);
  return res.json();
}

function getDayName(dateStr) {
  const days = ["CN","T2","T3","T4","T5","T6","T7"];
  const d = new Date(dateStr);
  return days[d.getDay()];
}

function weatherIcon(code) {
  // Map weathercode to iOS-style weather-icons
  const map = {
    0: "wi-day-sunny",
    1: "wi-day-sunny-overcast",
    2: "wi-day-cloudy",
    3: "wi-cloudy",
    45: "wi-fog",
    48: "wi-fog",
    51: "wi-sprinkle",
    61: "wi-rain",
    71: "wi-snow",
    95: "wi-thunderstorm"
  };
  return map[code] || "wi-day-sunny";
}

async function renderFixedLocations() {
  const container = document.getElementById("fixedLocations");
  container.innerHTML = "";
  for (let loc of fixedLocations) {
    const data = await getWeather(loc.lat, loc.lon);
    const block = document.createElement("div");
    block.className = "location-block";
    block.innerHTML = `<div class="location-title">${loc.name}</div>`;
    const grid = document.createElement("div");
    grid.className = "forecast-grid";
    data.daily.time.forEach((date, i) => {
      const card = document.createElement("div");
      card.className = "day-card";
      card.style.background = dayColors[i % dayColors.length];
      card.innerHTML = `
        <div class="day-name">${getDayName(date)}</div>
        <i class="wi ${weatherIcon(data.daily.weathercode[i])}" style="font-size:24px;"></i>
        <div class="temp-high">${data.daily.temperature_2m_max[i]}°</div>
        <div class="temp-low">${data.daily.temperature_2m_min[i]}°</div>
        <div>${data.daily.precipitation_probability_mean[i]}%</div>
      `;
      grid.appendChild(card);
    });
    block.appendChild(grid);
    container.appendChild(block);
  }
}

async function getLocationName(lat, lon) {
  const res = await fetch(`https://nominatim.openstreetmap.org/reverse?lat=${lat}&lon=${lon}&format=json&accept-language=vi`);
  const json = await res.json();
  let name = "";
  if (json.address) {
    const addr = json.address;
    name = `${addr.village || addr.town || addr.suburb || addr.hamlet || ""} - ${addr.state || addr.county || addr.city || ""}`;
  }
  return name || "Không xác định";
}

async function showMap() {
  const map = L.map('map').setView([15.9, 105.8], 5);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '&copy; OpenStreetMap'
  }).addTo(map);

  let popupMarker;

  map.on('click', async function(e) {
    const lat = e.latlng.lat;
    const lon = e.latlng.lng;
    const name = await getLocationName(lat, lon);
    const data = await getWeather(lat, lon);

    if (popupMarker) map.removeLayer(popupMarker);

    let forecastHtml = `<b>${name}</b><br><div style="display:flex;gap:5px;overflow-x:auto;">`;
    data.daily.time.forEach((date, i) => {
      forecastHtml += `
        <div style="background:${dayColors[i % dayColors.length]};color:white;border-radius:6px;padding:4px;min-width:60px;text-align:center;">
          ${getDayName(date)}<br>
          <i class="wi ${weatherIcon(data.daily.weathercode[i])}" style="font-size:20px;"></i><br>
          <span style="color:red;">${data.daily.temperature_2m_max[i]}°</span><br>
          <span style="color:blue;">${data.daily.temperature_2m_min[i]}°</span><br>
          ${data.daily.precipitation_probability_mean[i]}%
        </div>
      `;
    });
    forecastHtml += "</div>";

    popupMarker = L.popup()
      .setLatLng(e.latlng)
      .setContent(forecastHtml)
      .openOn(map);
  });
}

renderFixedLocations();
showMap();
</script>

</body>
</html>
